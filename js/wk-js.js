import*as THREE from"three";import{OrbitControls}from"https://threejs.org/examples/jsm/controls/OrbitControls.js";import{OBJLoader}from"https://threejs.org/examples/jsm/loaders/OBJLoader.js";import{MTLLoader}from"https://threejs.org/examples/jsm/loaders/MTLLoader.js";import{GUI}from"https://threejs.org/examples/jsm/libs/lil-gui.module.min.js";import{FBXLoader}from"https://threejs.org/examples/jsm/loaders/FBXLoader.js";fetchFun();async function fetchFun(){let a=await fetch("./json/3DMTLOBJ.json"),b=await a.json(),c=await fetch("./json/3DFBX.json"),d=await c.json();main(b,d)}function main(a,b){function c(a=75){const b=window.innerWidth/window.innerHeight;return new THREE.PerspectiveCamera(a,b,.1,100)}function d(a){const b=new THREE.TextureLoader,c=b.load(a);u.background=c}function e(a){const b=new MTLLoader;b.load(a.pathMTL,b=>{b.preload();const c=new OBJLoader;c.setMaterials(b),c.load(a.pathOBJ,b=>{u.add(b),b.position.set(...a.position),b.scale.set(...a.scale),b.name=a.name,f(b)})})}function f(a){a.traverse(function(a){a.isMesh&&(a.castShadow=!0,a.receiveShadow=!0)})}function g(a,b,c){let d=new FBXLoader;d.load(b.path,function(d){o[a][c]=new THREE.AnimationMixer(d),f(d),d.position.set(...b.position),d.name=b.name,d.visible=!1,d.scale.set(...b.scale),u.add(d)})}function h(a){function b(a,b,d){let e=u.getObjectByName(m[a][d].name);e.position.set(m[a][d].position[0]-.5,m[a][d].position[1],m[a][d].position[2]+c.y)}const c=new THREE.Vector2;z.getPointAt(.5*a%1,c),m.forEach((a,c)=>a.forEach((a,d)=>b(c,a,d)))}function j(a){a*=1e-4;{function b(b){b&&(b.update(.02),b._root.visible&&h(a))}const c=v.domElement;H.forEach(a=>{const b=a.cam;b.aspect=c.clientWidth/c.clientHeight,b.updateProjectionMatrix()});let d=0|10*(.25*a)%H.length,e=H[0|d],f=I[0|d];O||(e=H[0],f=I[0]),J.textContent=e.desc,K.textContent=f.desc,v.render(u,e.cam),u.rotation.y=O?0:a,o.forEach(a=>a.forEach(b))}requestAnimationFrame(j)}function k(){let a="./sounds/Piano-Sonata-14-Moonlightxx.mp3";O?a="./sounds/Symphony-5.mp3":"./sounds/Piano-Sonata-14-Moonlightxx.mp3",Q.isPlaying&&Q.stop(),R.load(a,function(a){Q.setBuffer(a),Q.setLoop(!0),Q.setVolume(.5),S?(Q.play(),T.classList.remove("disabled")):(Q.isPlaying&&Q.stop(),T.classList.add("disabled"))})}let l=[...a],m=[...b];const n=["./images/bg-3-deep.jpg","./images/bg-3-invert-black.jpg"],o=Array(m.length);for(var p=0;p<m.length;p++)o[p]=Array(m[0].length);let q=Array(m.length).fill(Array(m[0].length).fill(null)),r=Array(m.length).fill(Array(m[0].length).fill(null)),s=[];const t=document.querySelector("#c"),u=new THREE.Scene;u.rotation.x=-.35*Math.PI;const v=new THREE.WebGLRenderer({canvas:t,alpha:!0});v.outputEncoding=THREE.sRGBEncoding,v.shadowMap.enabled=!0,document.body.appendChild(v.domElement);const w=c();w.position.set(0,32,2);const x=new OrbitControls(w,t);x.target.set(0,25,0),x.update(),l.forEach((a,b)=>e(a,b)),m.forEach((a,b)=>a.forEach((a,c)=>g(b,a,c))),d(n[0]);let y;(function(){const a=new THREE.TextureLoader,b=a.load("https://threejs.org/manual/examples/resources/images/checker.png");b.encoding=THREE.sRGBEncoding,b.wrapS=THREE.RepeatWrapping,b.wrapT=THREE.RepeatWrapping,b.magFilter=THREE.NearestFilter;const c=new THREE.CircleGeometry(18.1,100),d=new THREE.MeshPhongMaterial({map:b,side:THREE.DoubleSide,opacity:.3,transparent:!0}),e=new THREE.Mesh(c,d);e.rotation.x=-.5*Math.PI,e.receiveShadow=!0,e.name="direct_light",y=e,u.add(e)})(),function(){const a=new THREE.HemisphereLight(11657727,12155424,.5);a.position.set(0,0,30),u.add(a)}(),function(){const a=new THREE.SpotLight(16777215,2);a.position.set(0,18,0),a.target.position.set(0,0,0),a.castShadow=!0,a.angle=Math.PI/4,u.add(a),u.add(a.target),a.rotation.x=-.3*Math.PI;(function(){a.target.updateMatrixWorld()})()}(),requestAnimationFrame(j);const z=new THREE.SplineCurve([new THREE.Vector2(8,-8),new THREE.Vector2(8,4)]),A=z.getPoints(100),B=new THREE.BufferGeometry().setFromPoints(A),C=new THREE.LineBasicMaterial({color:16711680});C.visible=!1;const D=new THREE.Line(B,C);D.rotation.x=.5*Math.PI,D.position.y=.05,u.add(D);const E=c();E.position.set(0,10,-20),u.add(E),E.lookAt(0,10,-5);const F=c();F.position.set(10,15,15),u.add(F),F.lookAt(0,7,0),F.rotation.z=.2*Math.PI;const G=c();G.position.set(0,5,30),u.add(G),G.lookAt(0,10,0);const H=[{cam:w,desc:"\u524D\u8996\u76F8\u6A5F"},{cam:E,desc:"\u5F8C\u8996\u76F8\u6A5F"},{cam:F,desc:" \u5074\u8996\u76F8\u6A5F"},{cam:G,desc:"\u52D5\u614B\u76F8\u6A5F"}],I=[{desc:"\u7D0D\u897F\u5E1D\u570B\u6B63\u96C6\u7D50\u5927\u8ECD\uFF0C\u9032\u653B\u6885\u6D1B\u8332\u5927\u9678..."},{desc:"\u5927\u8ECD\u6B63\u5411\u8457\u9B54\u57DF\u9ED1\u77F3\u6797\u524D\u9032..."},{desc:"\u6D69\u701A\u7684\u8ECD\u5BB9\u547C\u5929\u9707\u5730..."},{desc:"\u6230\u722D\u7684\u6C23\u606F\u7030\u6F2B\u6574\u500B\u5929\u7A7A..."}],J=document.querySelector("#info"),K=document.querySelector("#story");let L=!1;const M=document.querySelector(".js-lights-toggle");M.addEventListener("click",()=>{L=!L,L?(d(n[1]),u.children[0].material.opacity=1):(u.children[0].material.opacity=.3,d(n[0]))});const N=document.querySelector(".js-camera-toggle");let O=!1;N.addEventListener("click",()=>{function a(a,b){s[b]=u.getObjectByName(a.name),s[b].visible=!O}function b(a,b,c){r[a][c]=u.getObjectByName(b.name);let d=r[a][c];d.visible=O,q[a][c]=o[a][c].clipAction(d.animations[0]),O?q[a][c].play():q[a][c].stop()}O=!O,S&&k(),l.forEach(a),m.forEach((a,c)=>a.forEach((a,d)=>b(c,a,d)))});const P=new THREE.AudioListener,Q=new THREE.Audio(P),R=new THREE.AudioLoader;w.add(P);let S=!1;const T=document.querySelector(".js-sound-toggle");T.addEventListener("click",()=>{S=!S,k()})}